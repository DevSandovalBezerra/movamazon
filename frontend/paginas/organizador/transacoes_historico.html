<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico de Transa√ß√µes - Mercado Pago</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 0.35em 0.65em;
            font-size: 0.85em;
            font-weight: 600;
            border-radius: 0.25rem;
        }
        .card-stats {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .card-stats:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .transaction-row:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .filter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-light">

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5>Consultando Mercado Pago...</h5>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2><i class="fas fa-chart-line me-2"></i>Hist√≥rico de Transa√ß√µes - Mercado Pago</h2>
                <p class="text-muted">Consulta direta na API do Mercado Pago - Transa√ß√µes bem-sucedidas e falhadas</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="exportarCSV()">
                    <i class="fas fa-download me-2"></i>Exportar CSV
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card filter-card mb-4">
            <div class="card-body">
                <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">Todos</option>
                            <option value="approved">‚úÖ Aprovado</option>
                            <option value="pending">‚è≥ Pendente</option>
                            <option value="in_process">üîÑ Em Processamento</option>
                            <option value="rejected">‚ùå Rejeitado</option>
                            <option value="cancelled">üö´ Cancelado</option>
                            <option value="refunded">üí∏ Reembolsado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" class="form-control" id="filterBeginDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Refer√™ncia</label>
                        <input type="text" class="form-control" id="filterReference" placeholder="INSCRI√á√ÉO_123">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <button class="btn btn-light me-2" onclick="aplicarFiltros()">
                            <i class="fas fa-search me-2"></i>Buscar
                        </button>
                        <button class="btn btn-outline-light" onclick="limparFiltros()">
                            <i class="fas fa-times me-2"></i>Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="row mb-4" id="statsContainer">
            <!-- Cards de estat√≠sticas ser√£o inseridos aqui -->
        </div>

        <!-- Tabela de Transa√ß√µes -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Transa√ß√µes</h5>
                    <span class="badge bg-primary" id="totalTransacoes">0 transa√ß√µes</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Payment ID</th>
                                <th>Status</th>
                                <th>Refer√™ncia</th>
                                <th>Participante</th>
                                <th>Evento</th>
                                <th>M√©todo</th>
                                <th class="text-end">Valor</th>
                                <th class="text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="transacoesBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Clique em "Buscar" para consultar as transa√ß√µes</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white" id="paginacaoContainer">
                <!-- Pagina√ß√£o ser√° inserida aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Transa√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalDetalhesContent">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = null;
        let currentOffset = 0;
        const LIMIT = 50;

        // ========================================
        // üîç BUSCAR TRANSA√á√ïES
        // ========================================
        
        async function aplicarFiltros(offset = 0) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            const params = new URLSearchParams({
                status: document.getElementById('filterStatus').value,
                begin_date: document.getElementById('filterBeginDate').value,
                end_date: document.getElementById('filterEndDate').value,
                external_reference: document.getElementById('filterReference').value,
                limit: LIMIT,
                offset: offset
            });

            // Remover par√¢metros vazios
            [...params.keys()].forEach(key => {
                if (!params.get(key)) params.delete(key);
            });

            try {
                const response = await fetch(`/api/organizador/transacoes/historico_mercadopago.php?${params}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Erro ao consultar transa√ß√µes');
                }

                currentData = data;
                currentOffset = offset;
                renderizarTransacoes(data);
                renderizarEstatisticas(data.estatisticas);
                renderizarPaginacao(data.paginacao);

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao consultar transa√ß√µes: ' + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // ========================================
        // üìä RENDERIZAR ESTAT√çSTICAS
        // ========================================
        
        function renderizarEstatisticas(stats) {
            const container = document.getElementById('statsContainer');
            
            const cards = [
                {
                    icon: 'fa-check-circle',
                    title: 'Aprovados',
                    value: `R$ ${stats.valor_total_aprovado.toFixed(2)}`,
                    subtitle: `${stats.por_status?.approved?.count || 0} transa√ß√µes`,
                    color: '#28a745',
                    bg: '#d4edda'
                },
                {
                    icon: 'fa-times-circle',
                    title: 'Rejeitados',
                    value: `R$ ${stats.valor_total_rejeitado.toFixed(2)}`,
                    subtitle: `${stats.por_status?.rejected?.count || 0} transa√ß√µes`,
                    color: '#dc3545',
                    bg: '#f8d7da'
                },
                {
                    icon: 'fa-clock',
                    title: 'Pendentes',
                    value: `R$ ${stats.valor_total_pendente.toFixed(2)}`,
                    subtitle: `${(stats.por_status?.pending?.count || 0) + (stats.por_status?.in_process?.count || 0)} transa√ß√µes`,
                    color: '#ffc107',
                    bg: '#fff3cd'
                },
                {
                    icon: 'fa-percentage',
                    title: 'Taxa Aprova√ß√£o',
                    value: `${stats.taxa_aprovacao}%`,
                    subtitle: `${stats.total_transacoes} transa√ß√µes totais`,
                    color: '#17a2b8',
                    bg: '#d1ecf1'
                }
            ];

            container.innerHTML = cards.map(card => `
                <div class="col-md-3">
                    <div class="card card-stats h-100" style="border-left-color: ${card.color};">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted mb-1 small">${card.title}</p>
                                    <h4 class="mb-0">${card.value}</h4>
                                    <small class="text-muted">${card.subtitle}</small>
                                </div>
                                <div class="text-end">
                                    <i class="fas ${card.icon} fa-2x" style="color: ${card.color}; opacity: 0.5;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // üìã RENDERIZAR TRANSA√á√ïES
        // ========================================
        
        function renderizarTransacoes(data) {
            const tbody = document.getElementById('transacoesBody');
            const transacoes = data.transacoes;

            document.getElementById('totalTransacoes').textContent = 
                `${transacoes.length} de ${data.paginacao.total} transa√ß√µes`;

            if (transacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhuma transa√ß√£o encontrada com os filtros aplicados</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transacoes.map(t => `
                <tr class="transaction-row" onclick="mostrarDetalhes(${t.payment_id})">
                    <td>${formatarData(t.date_created)}</td>
                    <td><code>${t.payment_id}</code></td>
                    <td><span class="badge bg-${t.status_cor}">${t.status_traduzido}</span></td>
                    <td>${t.external_reference || '-'}</td>
                    <td>${t.inscricao ? t.inscricao.usuario_nome : t.payer.first_name + ' ' + t.payer.last_name}</td>
                    <td>${t.inscricao ? t.inscricao.evento_nome : '-'}</td>
                    <td><span class="badge bg-secondary">${t.payment_method_id || t.payment_type_id}</span></td>
                    <td class="text-end fw-bold">R$ ${t.transaction_amount.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); mostrarDetalhes(${t.payment_id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ========================================
        // üìÑ PAGINA√á√ÉO
        // ========================================
        
        function renderizarPaginacao(paginacao) {
            const container = document.getElementById('paginacaoContainer');
            
            const currentPage = Math.floor(paginacao.offset / paginacao.limit) + 1;
            const totalPages = Math.ceil(paginacao.total / paginacao.limit);

            container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        Mostrando ${paginacao.offset + 1} - ${Math.min(paginacao.offset + paginacao.limit, paginacao.total)} de ${paginacao.total}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="aplicarFiltros(${paginacao.offset - paginacao.limit})"
                                ${!paginacao.has_prev ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <button class="btn btn-sm btn-outline-primary disabled">
                            P√°gina ${currentPage} de ${totalPages}
                        </button>
                        <button class="btn btn-sm btn-outline-primary"
                                onclick="aplicarFiltros(${paginacao.offset + paginacao.limit})"
                                ${!paginacao.has_next ? 'disabled' : ''}>
                            Pr√≥xima <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // ========================================
        // üëÅÔ∏è MOSTRAR DETALHES
        // ========================================
        
        function mostrarDetalhes(paymentId) {
            const transacao = currentData.transacoes.find(t => t.payment_id == paymentId);
            if (!transacao) return;

            const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            const content = document.getElementById('modalDetalhesContent');

            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informa√ß√µes da Transa√ß√£o</h6>
                        <table class="table table-sm">
                            <tr><th>Payment ID:</th><td><code>${transacao.payment_id}</code></td></tr>
                            <tr><th>Status:</th><td><span class="badge bg-${transacao.status_cor}">${transacao.status_traduzido}</span></td></tr>
                            <tr><th>Valor:</th><td class="fw-bold">R$ ${transacao.transaction_amount.toFixed(2)}</td></tr>
                            <tr><th>M√©todo:</th><td>${transacao.payment_method_id || '-'}</td></tr>
                            <tr><th>Parcelas:</th><td>${transacao.installments}x</td></tr>
                            <tr><th>Data Cria√ß√£o:</th><td>${formatarDataCompleta(transacao.date_created)}</td></tr>
                            ${transacao.date_approved ? `<tr><th>Data Aprova√ß√£o:</th><td>${formatarDataCompleta(transacao.date_approved)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Dados do Comprador</h6>
                        <table class="table table-sm">
                            <tr><th>Email:</th><td>${transacao.payer.email || '-'}</td></tr>
                            <tr><th>Nome:</th><td>${transacao.payer.first_name || ''} ${transacao.payer.last_name || ''}</td></tr>
                            <tr><th>CPF:</th><td>${transacao.payer.identification?.number || '-'}</td></tr>
                        </table>
                        ${transacao.inscricao ? `
                            <h6 class="mt-3">Dados da Inscri√ß√£o</h6>
                            <table class="table table-sm">
                                <tr><th>ID:</th><td>${transacao.inscricao.id}</td></tr>
                                <tr><th>Evento:</th><td>${transacao.inscricao.evento_nome}</td></tr>
                                <tr><th>Participante:</th><td>${transacao.inscricao.usuario_nome}</td></tr>
                            </table>
                        ` : ''}
                    </div>
                </div>
                ${transacao.status_detail ? `
                    <div class="alert alert-info mt-3">
                        <strong>Detalhe do Status:</strong> ${transacao.status_detail}
                    </div>
                ` : ''}
            `;

            modal.show();
        }

        // ========================================
        // üßπ LIMPAR FILTROS
        // ========================================
        
        function limparFiltros() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterBeginDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterReference').value = '';
        }

        // ========================================
        // üì• EXPORTAR CSV
        // ========================================
        
        function exportarCSV() {
            if (!currentData || !currentData.transacoes.length) {
                alert('Nenhuma transa√ß√£o para exportar');
                return;
            }

            const csv = [
                ['Data', 'Payment ID', 'Status', 'Refer√™ncia', 'Participante', 'Evento', 'M√©todo', 'Valor'].join(';'),
                ...currentData.transacoes.map(t => [
                    formatarData(t.date_created),
                    t.payment_id,
                    t.status_traduzido,
                    t.external_reference || '',
                    t.inscricao ? t.inscricao.usuario_nome : `${t.payer.first_name} ${t.payer.last_name}`,
                    t.inscricao ? t.inscricao.evento_nome : '',
                    t.payment_method_id || t.payment_type_id,
                    t.transaction_amount.toFixed(2)
                ].join(';'))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transacoes_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ========================================
        // üé® UTILIT√ÅRIOS
        // ========================================
        
        function formatarData(dataISO) {
            if (!dataISO) return '-';
            const data = new Date(dataISO);
            return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatarDataCompleta(dataISO) {
            if (!dataISO) return '-';
            const data = new Date(dataISO);
            return data.toLocaleString('pt-BR');
        }

        // ========================================
        // üöÄ INICIALIZA√á√ÉO
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Definir data padr√£o (√∫ltimos 30 dias)
            const hoje = new Date();
            const tresDiasAtras = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('filterEndDate').valueAsDate = hoje;
            document.getElementById('filterBeginDate').valueAsDate = tresDiasAtras;
        });
    </script>
</body>
</html>
