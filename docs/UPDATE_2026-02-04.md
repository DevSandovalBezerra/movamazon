# Update - 04/02/2026

## Resumo das alterações

Registro de **tudo que foi feito no chat** nesta sessão:

1. **Exigências Mercado Pago (Device ID + Items)** – Implementação do Device ID (script `security.js`, envio no body e header `X-meli-session-id`), inclusão de `items` com `id`, `title`, `description`, `category_id`, `quantity`, `unit_price` em preference, process_payment (cartão), PIX e boleto.
2. **Webhook: validação da assinatura (x-signature)** – Uso do Webhook Secret do `.env` para validar a autenticidade das notificações via header `x-signature` (HMAC-SHA256). Suporte às variáveis `Webhook_Secret` e `ML_WEBHOOK_SECRET`.
3. **Plano documentado** – Plano de exigências MP (Device ID, items, PCI/Secure Fields, SDKs, medição de qualidade) e referência à documentação oficial.

---

## Índice

1. [Exigências Mercado Pago (Device ID + Items)](#1-exigências-mercado-pago-device-id--items)
2. [Webhook: validação x-signature](#2-webhook-validação-x-signature)
3. [Arquivos alterados – resumo](#3-arquivos-alterados--resumo)
4. [Guia de deploy](#4-guia-de-deploy)
5. [Referências](#5-referências)

---

## 1. Exigências Mercado Pago (Device ID + Items)

### Contexto

O Mercado Pago passou a exigir:

- **Identificador do dispositivo (Device ID):** usar SDK para tokenização ou implementar device ID no site.
- **Items no request de Pagamentos:** enviar `items.id`, `items.title`, `items.description`, `items.category_id`, `items.quantity`, `items.unit_price` para melhorar aprovação e detalhe do carrinho.
- **Categoria, descrição, código, quantidade, nome e preço do item** em todos os fluxos de pagamento.

### 1.1. Device ID

- **Frontend (páginas):** Inclusão do script de segurança do MP nas telas de pagamento:
  ```html
  <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>
  ```
  O script expõe a variável global `MP_DEVICE_SESSION_ID`.

- **Frontend (JS):** No envio para `process_payment_preference.php`, o body passou a incluir:
  - `device_id`: valor de `window.MP_DEVICE_SESSION_ID` (ou vazio).
  - `inscricao_id`: para o backend montar os `items`.

- **Backend:** Em `process_payment_preference.php`, quando `device_id` está presente, o header **`X-meli-session-id`** é enviado na requisição ao Mercado Pago.

### 1.2. Items completos

- **create_preference.php:** Cada item do array `items` passou a ter o campo **`id`** (ex.: `MOVAMAZON_{inscricao_id}` para o item principal, `extra_{inscricao_id}_{index}` para extras).

- **process_payment_preference.php:** Passa a aceitar `inscricao_id` no body; quando informado, busca inscrição (evento, modalidade, valor, produtos extras) e monta o array **`items`** no payload de `POST /v1/payments`.

- **create_pix.php:** Inclusão de `LEFT JOIN modalidades` na query da inscrição; montagem do array **`items`** (item principal + produtos extras) no payload enviado à API do MP.

- **create_boleto.php:** Mesma lógica do PIX: JOIN com modalidades e array **`items`** no payload.

Em todos os pontos foi mantido **`category_id` = `EBL-Evento Desportivo`**.

---

## 2. Webhook: validação x-signature

### Contexto

O Mercado Pago envia a **clave secreta** nas notificações Webhooks no header **`x-signature`** (formato `ts=...,v1=...`) para garantir que a notificação veio do MP. Documentação: [Webhooks - Validar origen](https://www.mercadopago.com.mx/developers/es/docs/checkout-pro/additional-content/notifications/webhooks).

### 2.1. Configuração do secret

- **config.php:** O webhook secret é lido na seguinte ordem:
  1. `ML_WEBHOOK_SECRET`
  2. `Webhook_Secret` (como no seu `.env`)

- Removido o valor padrão fixo; se nenhuma das variáveis existir, o secret fica vazio e a verificação não é executada (comportamento compatível com quem ainda não usa secret).

### 2.2. Validação no webhook.php

- Quando **`secret_key_webhook`** está configurado:
  1. Lê o header **`x-signature`** e extrai `ts` e `v1`.
  2. Obtém **`data.id`** dos query params (`$_GET['data.id']`) ou do body; se alfanumérico, em minúsculas.
  3. Obtém **`x-request-id`** do header.
  4. Monta o **manifest**: `id:{data.id};request-id:{x-request-id};ts:{ts};` (omitindo `request-id` se ausente).
  5. Calcula **HMAC-SHA256(manifest, secret)** em hex e compara com `v1` usando `hash_equals`.

- Se a assinatura for **inválida ou ausente**: responde HTTP 200 com `{"status":"error","reason":"signature_invalid"}`, não processa a notificação e registra em log.

- Se o secret **não** estiver configurado: o webhook segue sem verificação de assinatura (comportamento anterior).

---

## 3. Arquivos alterados – resumo

| Arquivo | Alteração |
|---------|-----------|
| `frontend/paginas/inscricao/pagamento.php` | Script `security.js` (view="checkout") em ambos os pontos de carregamento do SDK. |
| `frontend/paginas/participante/pagamento-inscricao.php` | Script `security.js` após o SDK. |
| `frontend/js/inscricao/pagamento.js` | Body da chamada a `process_payment_preference.php` com `device_id` e `inscricao_id`. |
| `frontend/js/participante/pagamento-inscricao.js` | Idem: `device_id` e `inscricao_id` (usando `window.inscricaoData?.id`). |
| `api/inscricao/process_payment_preference.php` | Header `X-meli-session-id`; aceita `inscricao_id` e monta `items` no payload; envia `items` para a API do MP. |
| `api/inscricao/create_preference.php` | Campo `id` em cada item de `items`. |
| `api/inscricao/create_pix.php` | JOIN modalidades; array `items` no payload PIX. |
| `api/inscricao/create_boleto.php` | JOIN modalidades; array `items` no payload boleto. |
| `api/mercadolivre/config.php` | Webhook secret: `ML_WEBHOOK_SECRET` ou `Webhook_Secret` (sem valor padrão fixo). |
| `api/mercadolivre/webhook.php` | Validação da assinatura `x-signature` quando secret configurado; rejeição com `signature_invalid` se inválida. |

---

## 4. Guia de deploy

### 4.1. Pré-requisitos

- Backup do banco de dados e dos arquivos alterados (ou commit em branch de deploy).
- Acesso ao servidor de produção e ao painel do Mercado Pago (Tus integraciones).
- Variável **Webhook_Secret** (ou **ML_WEBHOOK_SECRET**) no `.env` de produção com o valor da **clave secreta** exibida em **Webhooks > Configurar notificaciones** (o mesmo valor usado pelo MP para assinar o header `x-signature`).

### 4.2. Variáveis de ambiente (.env)

Garantir em produção:

```env
# Webhook: secret para validar assinatura x-signature (copiar de Tus integraciones > Webhooks)
Webhook_Secret=SEU_SECRET_AQUI
# ou
ML_WEBHOOK_SECRET=SEU_SECRET_AQUI
```

- O secret é gerado ao salvar a URL e os eventos em **Tus integraciones > Webhooks**. Se não tiver ainda, configurar a URL de notificação e salvar; em seguida revelar e copiar a clave secreta para o `.env`.
- **Não** alterar o `.env` de outro desenvolvedor sem combinar; se o time usar `ML_WEBHOOK_SECRET`, manter consistência.

### 4.3. Deploy dos arquivos

1. **Fazer upload** (ou pull da branch) dos arquivos listados na [seção 3](#3-arquivos-alterados--resumo) para o ambiente alvo, preservando paths:
   - `frontend/paginas/inscricao/pagamento.php`
   - `frontend/paginas/participante/pagamento-inscricao.php`
   - `frontend/js/inscricao/pagamento.js`
   - `frontend/js/participante/pagamento-inscricao.js`
   - `api/inscricao/process_payment_preference.php`
   - `api/inscricao/create_preference.php`
   - `api/inscricao/create_pix.php`
   - `api/inscricao/create_boleto.php`
   - `api/mercadolivre/config.php`
   - `api/mercadolivre/webhook.php`

2. **Não** alterar layout/CSS além do que já foi feito (apenas inclusão do script `security.js`).

3. **Permissões:** manter as mesmas de antes (ex.: leitura para arquivos PHP/JS, escrita apenas onde já existia para logs).

### 4.4. Verificações pós-deploy

1. **Webhook**
   - Fazer um pagamento de teste (PIX ou cartão) em produção e conferir se a notificação é processada (inscrição atualizada, logs em `webhook_mp.log` / `webhook_retorno.txt`).
   - Se o secret estiver configurado e o MP enviar `x-signature`, não deve aparecer `signature_invalid` para notificações legítimas.
   - Em **Tus integraciones > Webhooks**, conferir se a URL de produção está correta e se o secret do painel é o mesmo do `.env`.

2. **Pagamento (cartão)**
   - Abrir a tela de pagamento (inscrição e participante), verificar se o Brick e o script `security.js` carregam sem erro no console.
   - Concluir um pagamento de teste com cartão e conferir se o status é atualizado e se não há erro 4xx/5xx na chamada a `process_payment_preference.php`.

3. **PIX e boleto**
   - Gerar PIX e boleto de teste e conferir se a criação na API do MP retorna sucesso e se os `items` estão sendo enviados (pode checar em log temporário ou no painel do MP, se disponível).

4. **Medição de qualidade (opcional)**
   - Em [Suas integrações](https://www.mercadopago.com.br/developers/panel/app) > sua aplicação > **Detalhes da aplicação**, usar **Medir novamente** com um Payment ID de um pagamento produtivo para verificar a pontuação após as melhorias (Device ID + items).

### 4.5. Rollback (se necessário)

- Reverter os 10 arquivos listados para a versão anterior ao deploy.
- Se tiver adicionado apenas `Webhook_Secret`/`ML_WEBHOOK_SECRET` nesta leva, pode deixar a variável no `.env`; com secret vazio ou sem validação no código antigo, o webhook continua funcionando sem checagem de assinatura.

### 4.6. Documentação de referência

- [Simulador e clave secreta - Webhooks](https://www.mercadopago.com.ar/developers/es/news/2024/01/11/Webhooks-Notifications-Simulator-and-Secret-Signature)
- [Webhooks - Validar origen de una notificación](https://www.mercadopago.com.mx/developers/es/docs/checkout-pro/additional-content/notifications/webhooks)
- [Como medir a qualidade da integração](https://www.mercadopago.com.br/developers/pt/docs/integration-quality)
- `docs/COMO_VERIFICAR_WEBHOOK.md` (diagnóstico interno e causas comuns quando o webhook não responde)

---

## 5. Referências

- Plano de exigências MP: Device ID, items, PCI/Secure Fields, SDKs, medição de qualidade (registrado no chat; arquivo de plano em `.cursor/plans/` se aplicável).
- Documentação MP: Webhooks (x-signature), Checkout Bricks, Payments API (items).
- Projeto: `docs/COMO_VERIFICAR_WEBHOOK.md`, `docs/FORMATO_ENV_MERCADO_PAGO.md`.
